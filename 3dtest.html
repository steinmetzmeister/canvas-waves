<style>
body { margin: 0px; padding: 0px; }
#container { margin: 0px; padding: 0px; }
</style>

<div id="container"></div>

<audio id="audio" style="display: none;" autoplay>
    <source src="http://173.201.191.13:8000/;" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<script type="text/javascript">
var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

var audioEl = document.getElementById('audio');

var source = audioCtx.createMediaElementSource(audioEl);
var analyser = audioCtx.createAnalyser();

source.connect(analyser);
analyser.connect(audioCtx.destination);

analyser.fftSize = 32;
var frequencyData = new Uint8Array(analyser.frequencyBinCount);
</script>

<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r67/three.min.js"></script>
<script type="text/javascript">
var camera, scene, renderer;

var mats = [];
var meshes = [];
var speeds = [];

init();
animate();

function init() {

    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('container').appendChild(renderer.domElement);

    camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );

    scene = new THREE.Scene();

    mats.push(new THREE.MeshBasicMaterial({ color: 0xFFFFFF, wireframe: true }));
    mats.push(new THREE.MeshBasicMaterial({ color: 0x912CEE, wireframe: false }))
    // mats.push(new THREE.MeshBasicMaterial({ color: "lightblue", wireframe: true }));

    for (var i = 0; i < 10; i++)
    {
        speeds.push(Math.random() * 0.025);

        var j = 128 - i * 10;
        // var j = Math.floor(Math.random() * (176 - 96)) + 96;
        // var k = Math.floor(Math.random() * mats.length);
        var geo = new THREE.BoxGeometry(j, j, j);

        if (i == 9)
            var mesh = new THREE.Mesh(geo, mats[1]);
        else
            var mesh = new THREE.Mesh(geo, mats[0]);

        // mesh.rotation.x = Math.random();
        // mesh.rotation.y = Math.random();
        // mesh.rotation.z = Math.random();

        meshes.push(mesh);

        scene.add(mesh);
    }

    window.addEventListener('resize', onWindowResize, false);
    document.getElementById('container').addEventListener('click', function() {
        audioEl.play();
        console.log(12);
    }, false);
}

function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize(window.innerWidth, window.innerHeight);

}

var angle = 0;
function animate() {
    analyser.getByteFrequencyData(frequencyData);

    camera.lookAt(new THREE.Vector3(0,0,0));

    angle += 0.01;

    camera.position.x = Math.sin(angle) * 32;
    camera.position.y = Math.cos(angle) * 32;
    camera.position.z = Math.cos(angle) * 32;

    meshes[meshes.length - 1].rotation.x = Math.sin(angle);
    meshes[meshes.length - 1].rotation.y = Math.cos(angle);
    meshes[meshes.length - 1].rotation.z = Math.cos(angle);

    requestAnimationFrame( animate );

    for (var i = 0; i < meshes.length; i++)
    {

          meshes[i].material.color.setHex(Math.random() * 0xFFFFFF);

        var j = i;

        var k = map(frequencyData[j], 0, 255, 0.01, 1);

        meshes[i].scale.x = k;
        meshes[i].scale.y = k;
        meshes[i].scale.z = k;
    }

    renderer.render( scene, camera );
}

function map(value, low1, high1, low2, high2) {
    return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
}
</script>
